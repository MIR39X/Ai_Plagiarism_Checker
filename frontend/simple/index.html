<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Plagiarism Checker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#0f172a; color:#e2e8f0; }
    header { padding: 1.5rem; background: linear-gradient(135deg,#0ea5e9,#6366f1); color:#0b1120; }
    main { padding: 1.5rem; max-width: 1100px; margin: 0 auto; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:1.25rem; margin-bottom:1rem; box-shadow:0 10px 30px rgba(0,0,0,0.35); }
    label { display:block; margin-bottom:0.35rem; color:#cbd5e1; }
    input[type="file"], select, input[type="number"], button { width:100%; padding:0.65rem; border-radius:8px; border:1px solid #1f2937; background:#0b1220; color:#e2e8f0; }
    button { cursor:pointer; background:#22d3ee; color:#0b1120; font-weight:700; border:none; transition:transform 0.1s ease, box-shadow 0.2s; }
    button:hover { box-shadow:0 10px 30px rgba(34,211,238,0.2); transform:translateY(-1px); }
    .grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .pill { display:inline-block; padding:0.2rem 0.55rem; border-radius:999px; font-size:0.8rem; font-weight:700; }
    .pill.ai { background:#f87171; color:#0b1120; }
    .pill.human { background:#34d399; color:#0b1120; }
    .small { font-size:0.85rem; color:#94a3b8; }
    pre { white-space:pre-wrap; word-break:break-word; background:#0b1220; padding:0.75rem; border-radius:8px; border:1px solid #1f2937; }
    .flex { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <h1>AI Plagiarism Checker</h1>
    <p class="small" style="color:#0b1120;font-weight:700;">Upload a PDF/DOCX, choose mock or live analyze, and view per-segment confidences.</p>
  </header>
  <main>
    <div class="card">
      <div class="grid">
        <div>
          <label for="file">Document</label>
          <input type="file" id="file" accept=".pdf,.doc,.docx" />
        </div>
        <div>
          <label for="mode">Endpoint</label>
          <select id="mode">
            <option value="mock">Mock (no cost)</option>
            <option value="analyze">Analyze (live API)</option>
          </select>
        </div>
        <div>
          <label for="segmentTokens">Segment tokens (optional)</label>
          <input type="number" id="segmentTokens" min="20" max="400" placeholder="default 80" />
        </div>
      </div>
      <div style="margin-top:1rem;" class="row">
        <button id="submit" type="button" style="max-width:220px;">Run Analysis</button>
        <span id="status" class="small"></span>
      </div>
    </div>

    <div class="card" id="summary" style="display:none;">
      <h2>Summary</h2>
      <div class="grid">
        <div>
          <div class="small">AI Percentage</div>
          <div id="aiPercent" style="font-size:1.8rem;font-weight:800;">--</div>
        </div>
        <div>
          <div class="small">Segments</div>
          <div id="numSegments" style="font-size:1.4rem;font-weight:700;">--</div>
        </div>
        <div>
          <div class="small">Total Tokens</div>
          <div id="totalTokens" style="font-size:1.4rem;font-weight:700;">--</div>
        </div>
        <div>
          <div class="small">Download Token</div>
          <div id="downloadToken" style="font-size:1.1rem;font-weight:600;">--</div>
        </div>
      </div>
    </div>

    <div class="card" id="segments" style="display:none;">
      <h2>Segments</h2>
      <div id="segmentList" class="grid"></div>
    </div>
  </main>
  <div id="debugWrapper" style="max-width:1100px;margin:0 auto 2rem;">
    <div class="small" style="margin-bottom:0.5rem;">Debug (raw responses & errors)</div>
    <pre id="debug" class="small" style="min-height:80px;">No debug yet.</pre>
  </div>

  <script>
    // Point to the PHP backend. If you're viewing this over a different port (e.g., 5500), we still target 8000 for the API.
    const API_BASE = `${window.location.protocol}//${window.location.hostname}:8000`;
    const fileInput = document.getElementById('file');
    const modeSelect = document.getElementById('mode');
    const segmentTokensInput = document.getElementById('segmentTokens');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit');
    const summaryCard = document.getElementById('summary');
    const segmentsCard = document.getElementById('segments');
    const aiPercentEl = document.getElementById('aiPercent');
    const numSegmentsEl = document.getElementById('numSegments');
    const totalTokensEl = document.getElementById('totalTokens');
    const downloadTokenEl = document.getElementById('downloadToken');
    const segmentListEl = document.getElementById('segmentList');
    const debugEl = document.getElementById('debug');

    submitBtn.addEventListener('click', async (evt) => {
      evt.preventDefault();
      const file = fileInput.files[0];
      const mode = modeSelect.value;
      if (!file && mode === 'analyze') {
        statusEl.textContent = 'Choose a PDF/DOCX file for analyze.';
        return;
      }
      submitBtn.disabled = true;
      statusEl.textContent = 'Running...';
      summaryCard.style.display = 'none';
      segmentsCard.style.display = 'none';
      segmentListEl.innerHTML = '';
      debugEl.textContent = 'Running...';

      console.log('API_BASE', API_BASE, 'mode', mode);

      try {
        let data;
        if (mode === 'mock') {
          const res = await fetch(`${API_BASE}/mock.php`);
          const raw = await res.text();
          debugEl.textContent = `Mock raw response:\n${raw}`;
          if (!res.ok) throw new Error(raw || 'Mock request failed');
          try {
            data = JSON.parse(raw);
          } catch (e) {
            throw new Error('Mock parse failed: ' + raw.slice(0, 200));
          }
        } else {
          const form = new FormData();
          form.append('file', file);
          const tokens = segmentTokensInput.value;
          if (tokens) form.append('segment_tokens', tokens);
          const res = await fetch(`${API_BASE}/analyze.php`, { method: 'POST', body: form });
          const raw = await res.text();
          debugEl.textContent = `Analyze raw response:\n${raw}`;
          if (!res.ok) {
            let msg = raw || 'Analyze request failed';
            try {
              const errJson = JSON.parse(raw);
              msg = errJson.error || JSON.stringify(errJson);
            } catch (e) {
              // keep raw
            }
            throw new Error(msg);
          }
          try {
          data = JSON.parse(raw);
          } catch (e) {
            throw new Error('Analyze parse failed: ' + raw.slice(0, 200));
          }
        }

        renderResults(data);
        statusEl.textContent = 'Done';
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        console.error(err);
        debugEl.textContent += `\nError: ${err.message}`;
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Surface uncaught errors to the page for easier debugging
    window.addEventListener('error', (e) => {
      statusEl.textContent = 'Error: ' + e.message;
      debugEl.style.display = 'block';
      debugEl.textContent = 'Window error: ' + e.message;
    });

    function renderResults(data) {
      aiPercentEl.textContent = (data.ai_percent ?? '--') + '%';
      numSegmentsEl.textContent = data.num_segments ?? '--';
      totalTokensEl.textContent = data.total_tokens ?? '--';
      downloadTokenEl.textContent = data.download_token ?? '--';
      summaryCard.style.display = 'block';

      segmentListEl.innerHTML = '';
      (data.segments || []).forEach(seg => {
        const card = document.createElement('div');
        card.className = 'card';
        const pillClass = seg.is_ai ? 'pill ai' : 'pill human';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;">
            <div class="small">${seg.id || ''} · Page ${seg.page ?? '-'} · Tokens ${seg.tokens ?? '-'}</div>
            <span class="${pillClass}">${seg.is_ai ? 'AI' : 'Human'} (${seg.confidence ?? 0})</span>
          </div>
          <pre>${seg.text || ''}</pre>
        `;
        segmentListEl.appendChild(card);
      });

      segmentsCard.style.display = 'block';
    }
  </script>
</body>
</html>
