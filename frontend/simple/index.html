<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Plagiarism Checker</title>
  <style>
    :root {
      --bg: #050914;
      --panel: #0c1222;
      --border: #1c2538;
      --text: #e8ecf5;
      --muted: #9ba7bf;
      --accent: #21d4fd;
      --accent2: #6b8bff;
      --ai: #f87171;
      --human: #34d399;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Inter", Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 32px 20px; background: linear-gradient(120deg, var(--accent), var(--accent2)); color: #041227; }
    header h1 { margin: 0 0 8px; font-size: 32px; }
    header p { margin: 0; font-weight: 600; color: #05142d; }
    main { max-width: 1200px; margin: 0 auto; padding: 24px 20px 60px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); margin-bottom: 16px; }
    label { display:block; margin-bottom:6px; color: var(--muted); font-weight:600; }
    input[type="file"], select, input[type="number"] { width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); background:#0a1120; color: var(--text); }
    button { padding:12px 16px; border-radius:10px; border:none; font-weight:700; cursor:pointer; background: var(--accent); color:#041227; transition: transform 0.1s ease, box-shadow 0.2s; }
    button:hover { box-shadow:0 12px 30px rgba(33,212,253,0.25); transform: translateY(-1px); }
    button:disabled { opacity:0.6; cursor:not-allowed; box-shadow:none; transform:none; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); align-items: center; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .pill.ai { background: var(--ai); color:#0b1120; }
    .pill.human { background: var(--human); color:#0b1120; }
    .small { font-size: 13px; color: var(--muted); }
    pre { background:#0a1120; border:1px solid var(--border); border-radius:12px; padding:12px; white-space:pre-wrap; word-break:break-word; color:#cbd5f1; }
    h2 { margin:0 0 10px; }
    .layout-split { display:grid; grid-template-columns: 320px 1fr; gap:16px; align-items:start; }
    @media (max-width: 900px) { .layout-split { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>AI Plagiarism Checker</h1>
    <p>Upload a PDF/DOCX, choose mock or live analyze, and view per-segment confidences.</p>
  </header>

  <main>
    <section class="card">
      <div class="grid">
        <div>
          <label for="file">Document</label>
          <input type="file" id="file" accept=".pdf,.doc,.docx" />
        </div>
        <div>
          <label for="segmentTokens">Segment tokens (optional)</label>
          <input type="number" id="segmentTokens" min="20" max="400" placeholder="default 80" />
        </div>
      </div>
      <div class="row" style="margin-top:14px;">
        <button id="submit" type="button" style="min-width:180px;">Run Analysis</button>
        <span id="status" class="small"></span>
        <button id="toggleDebug" type="button" style="background:transparent;color:var(--muted);border:1px solid var(--border);">Toggle Debug</button>
      </div>
    </section>

    <section class="card" id="summary" style="display:none;">
      <h2>Summary</h2>
      <div class="layout-split">
        <div>
          <canvas id="aiChart" width="240" height="240" style="width:100%; height:auto;"></canvas>
        </div>
        <div class="grid">
          <div>
            <div class="small">AI Percentage</div>
            <div id="aiPercent" style="font-size:28px;font-weight:800;">--</div>
          </div>
          <div>
            <div class="small">Segments</div>
            <div id="numSegments" style="font-size:22px;font-weight:700;">--</div>
          </div>
          <div>
            <div class="small">Total Tokens</div>
            <div id="totalTokens" style="font-size:22px;font-weight:700;">--</div>
          </div>
          <div>
            <div class="small">Download Token</div>
            <div id="downloadToken" style="font-size:16px;font-weight:600;">--</div>
            <button id="downloadBtn" type="button" style="margin-top:6px;min-width:160px;">Download (placeholder)</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="segments" style="display:none;">
      <h2>Segments</h2>
      <div id="segmentList" class="grid"></div>
    </section>

    <section class="card" id="debugSection">
      <h2 style="margin-bottom:8px;">Debug (raw responses & errors)</h2>
      <pre id="debug">No debug yet.</pre>
    </section>
  </main>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';

    const fileInput = document.getElementById('file');
    const segmentTokensInput = document.getElementById('segmentTokens');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit');
    const toggleDebugBtn = document.getElementById('toggleDebug');
    const summaryCard = document.getElementById('summary');
    const segmentsCard = document.getElementById('segments');
    const aiPercentEl = document.getElementById('aiPercent');
    const numSegmentsEl = document.getElementById('numSegments');
    const totalTokensEl = document.getElementById('totalTokens');
    const downloadTokenEl = document.getElementById('downloadToken');
    const segmentListEl = document.getElementById('segmentList');
    const debugEl = document.getElementById('debug');
    const downloadBtn = document.getElementById('downloadBtn');
    const aiChartEl = document.getElementById('aiChart');

    let debugVisible = true;
    let aiChartCtx = aiChartEl.getContext('2d');

    function setDebug(text) {
      debugEl.textContent = text;
    }

    toggleDebugBtn.addEventListener('click', () => {
      debugVisible = !debugVisible;
      document.getElementById('debugSection').style.display = debugVisible ? 'block' : 'none';
    });

    submitBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        statusEl.textContent = 'Choose a PDF/DOCX file.';
        return;
      }
      submitBtn.disabled = true;
      statusEl.textContent = 'Running...';
      summaryCard.style.display = 'none';
      segmentsCard.style.display = 'none';
      segmentListEl.innerHTML = '';
      setDebug('Running...');
      document.getElementById('debugSection').style.display = 'block';

      try {
        let data;
        const form = new FormData();
        form.append('file', file);
        const tokens = segmentTokensInput.value;
        if (tokens) form.append('segment_tokens', tokens);
        const res = await fetch(`${API_BASE}/analyze.php`, { method: 'POST', body: form, cache: 'no-cache' });
        const raw = await res.text();
        setDebug(`Analyze raw response:\n${raw}`);
        if (!res.ok) {
          let msg = raw || 'Analyze request failed';
          try { const errJson = JSON.parse(raw); msg = errJson.error || JSON.stringify(errJson); } catch (e) {}
          throw new Error(msg);
        }
        try {
          data = JSON.parse(raw);
        } catch (e) {
          throw new Error('Analyze parse failed');
        }

        renderResults(data);
        statusEl.textContent = 'Done';
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        setDebug((debugEl.textContent || '') + `\nError: ${err.message}`);
        console.error(err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    function renderResults(data) {
      aiPercentEl.textContent = (data.ai_percent ?? '--') + '%';
      numSegmentsEl.textContent = data.num_segments ?? '--';
      totalTokensEl.textContent = data.total_tokens ?? '--';
      downloadTokenEl.textContent = data.download_token ?? '--';
      downloadBtn.onclick = () => {
        if (data.download_token) {
          window.open(`${API_BASE}/download.php?token=${encodeURIComponent(data.download_token)}`);
        }
      };
      summaryCard.style.display = 'block';

      drawChart(Number(data.ai_percent) || 0);

      segmentListEl.innerHTML = '';
      (data.segments || []).forEach(seg => {
        const card = document.createElement('div');
        card.className = 'card';
        const pillClass = seg.is_ai ? 'pill ai' : 'pill human';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div class="small">${seg.id || ''} · Page ${seg.page ?? '-'} · Tokens ${seg.tokens ?? '-'}</div>
            <span class="${pillClass}">${seg.is_ai ? 'AI' : 'Human'} (${seg.confidence ?? 0})</span>
          </div>
          <pre style="margin-top:8px;">${seg.text || ''}</pre>
        `;
        segmentListEl.appendChild(card);
      });

      segmentsCard.style.display = 'block';
    }

    function drawChart(aiPercent) {
      const percent = Math.max(0, Math.min(100, aiPercent));
      const angle = (percent / 100) * Math.PI * 2;
      const ctx = aiChartCtx;
      const size = aiChartEl.width;
      const center = size / 2;
      const radius = center - 14;
      ctx.clearRect(0,0,size,size);
      ctx.lineWidth = 18;
      ctx.strokeStyle = '#1f2937';
      ctx.beginPath(); ctx.arc(center, center, radius, 0, Math.PI * 2); ctx.stroke();
      ctx.strokeStyle = '#f87171';
      ctx.beginPath(); ctx.arc(center, center, radius, -Math.PI/2, -Math.PI/2 + angle); ctx.stroke();
      ctx.fillStyle = '#e2e8f0';
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(`${percent}% AI`, center, center);
    }

    // Show debug by default
    document.getElementById('debugSection').style.display = 'block';

    window.addEventListener('error', (e) => {
      statusEl.textContent = 'Error: ' + e.message;
      document.getElementById('debugSection').style.display = 'block';
      setDebug('Window error: ' + e.message);
    });

    window.addEventListener('unhandledrejection', (e) => {
      const msg = e.reason?.message || e.reason || 'Unhandled rejection';
      statusEl.textContent = 'Error: ' + msg;
      document.getElementById('debugSection').style.display = 'block';
      setDebug('Unhandled rejection: ' + msg);
    });

  </script>
</body>
</html>
